class FPBuddyWidgetsManager{_l={};layout_manager={};options={el_content:""};constructor(t){this.options=jQuery.extend({},this.options,t),this.setup=this.setup.bind(this),this.setup()}setup(){const t=this;if(!t.getElements())return!1;let e=this._l.parent.closest("form");e.length>0&&e.after(this._l.outer),this._l.parent.width()<500&&this._l.parent.addClass("layout-small"),jQuery('input[name="has_custom_frontpage"]').change((function(){t.toggleFPStatus(jQuery(this))})),t._l.parent.on("click",".fp-widget .js-toggle-widget-state",(function(e){e.preventDefault();let s=jQuery(this).closest(".fp-widget");if(s.hasClass("state-preview"))t.showWidgetOpts(s);else{s.addClass("state-preview").removeClass("state-edit");let t=s.closest(".row-contents");0===t.find(".fp-widget.state-edit").length&&0===t.find(".all-widgets-list").length&&t.removeClass("dblock")}})),t.layout_manager=new FPBuddyLayoutManager({parent:t._l.parent},FRONTPAGE_BUDDY.fp_layout,t),jQuery(document).on("fpbuddy_on_widget_edit",(function(e,s){"richcontent"===s.data("type")&&s.find("textarea").trumbowyg({btns:FRONTPAGE_BUDDY.rich_content.editor_btns,minimalLinks:!0}),t.bindWidgetOptsUpdate(s)})),t._l.parent.on("widget_updated",".fp-widget",(function(){const t=jQuery(this);let e=t.find(".field-heading input").val();if(e&&(e=jQuery.trim(e)),e)e=e.substring(0,100);else if(t.hasClass("widget-richcontent")){let s=t.find(".field .trumbowyg-box textarea").first().val();s.length>0&&(e=jQuery("<div>").html(s).text().substring(0,100))}else if(t.hasClass("widget-instagramprofile")){let s=t.find('.field [name="insta_id"]').first().val();s.length>0&&(s=jQuery.trim(s),e="@"+s.replace("@","")+" - instagram")}else if(t.hasClass("widget-twitterprofile")){let s=t.find('.field [name="username"]').first().val();s.length>0&&(s=jQuery.trim(s),e="@"+s.replace("@","")+" - X")}else e=t.attr("data-type");t.find(".fp-widget-title > span:last").text(e)}))}getElements(){return this._l.outer=jQuery(this.options.el_outer),this._l.parent=jQuery(this.options.el_content),this._l.parent.length>0}toggleFPStatus(t){let e="no";t.is(":checked")&&(e="yes"),"yes"==e?(jQuery(".show_if_fp_enabled").removeClass("fpbuddy_hidden"),jQuery(".hide_if_fp_enabled").addClass("fpbuddy_hidden")):(jQuery(".show_if_fp_enabled").addClass("fpbuddy_hidden"),jQuery(".hide_if_fp_enabled").removeClass("fpbuddy_hidden")),fetch(FRONTPAGE_BUDDY.config.rest_url_base+"/status",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":FRONTPAGE_BUDDY.config.rest_nonce},body:JSON.stringify({object_type:FRONTPAGE_BUDDY.object_type,object_id:FRONTPAGE_BUDDY.object_id,updated_status:e})})}getWidgetsList(){let t='<div class="all-widgets-list">';for(let e of FRONTPAGE_BUDDY.all_widgets)t+=`\n\t\t\t<div class="widget-to-add widget-${e.type}" data-type="${e.type}">\n\t\t\t\t<div class="widget-choose">\n\t\t\t\t\t<a href="#">\n\t\t\t\t\t\t<i class="gg-add"></i>\n\t\t\t\t\t\t<span>${e.name}</span>\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t`;return t+="</div>",t}initNewWidget(t,e){let s=Date.now()+"_"+Math.random(),i="",n="",a="";for(let e of FRONTPAGE_BUDDY.all_widgets)if(e.type===t){i=e.name,n=e.icon,a=e.description;break}let d=`\n\t\t\t<div class='widget-content'>\n\t\t\t\t<div class="fp-widget state-preview widget-${t}" data-id="${s}" data-type="${t}">\n\t\t\t\t\t<div class="fp-widget-header">\n\t\t\t\t\t\t<div class="fp-widget-title js-toggle-widget-state">\n\t\t\t\t\t\t\t${n}\n\t\t\t\t\t\t\t<span>${i}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="remove_item remove_widget">\n\t\t\t\t\t\t\t<a href="#"><i class="gg-close-r"></i></a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="widget-desc"><i class="gg-info"></i>${a}</div>\n\t\t\t\t\t<div class="widget-settings"></div>\n\t\t\t\t\t<div class="loading_overlay"><span class="helper"></span><img src="${FRONTPAGE_BUDDY.config.img_spinner}" ></div>\n\t\t\t\t</div>\n\t\t\t</div>\t\n\t\t`;e.html(d),this.showWidgetOpts(e.find(".fp-widget"))}getWidgetContents(t){let e=!1,s="",i="",n="",a="";for(let e of FRONTPAGE_BUDDY.added_widgets)if(e.id===t){s=e.type,i=e.title;break}if(s)for(let t of FRONTPAGE_BUDDY.all_widgets)if(t.type===s){i=i.length>0?i:t.name,a=t.description,n=t.icon,e=!0;break}return e?`\n\t\t\t<div class="fp-widget state-preview widget-${s}" data-id="${t}" data-type="${s}">\n\t\t\t\t<div class="fp-widget-header">\n\t\t\t\t\t<div class="fp-widget-title js-toggle-widget-state">\n\t\t\t\t\t\t${n}\n\t\t\t\t\t\t<span>${i}</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="remove_item remove_widget">\n\t\t\t\t\t\t<a href="#"><i class="gg-close-r"></i></a>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t\n\t\t\t\t<div class="widget-desc"><i class="gg-info"></i>${a}</div>\n\n\t\t\t\t<div class="widget-settings"></div>\n\n\t\t\t\t<div class="loading_overlay"><span class="helper"></span><img src="${FRONTPAGE_BUDDY.config.img_spinner}" ></div>\n\t\t\t</div>\n\t\t`:`\n\t\t\t\t<div>${FRONTPAGE_BUDDY.lang.invalid}</div>\n\t\t\t\t<div class="remove_item remove_widget">\n\t\t\t\t\t<a href="#"></a>\n\t\t\t\t</div>\n\t\t\t`}showWidgetOpts(t){if(t.find(".widget-settings form").length>0)return t.closest(".row-contents").addClass("dblock"),t.removeClass("state-preview").addClass("state-edit"),!1;t.addClass("loading");let e=new URL(FRONTPAGE_BUDDY.config.rest_url_base+"/widget-opts",window.location.origin),s={object_type:FRONTPAGE_BUDDY.object_type,object_id:FRONTPAGE_BUDDY.object_id,widget_type:t.data("type"),widget_id:t.data("id")};Object.keys(s).forEach((t=>e.searchParams.append(t,s[t]))),fetch(e.toString(),{method:"GET",headers:{"Content-Type":"application/json","X-WP-Nonce":FRONTPAGE_BUDDY.config.rest_nonce}}).then((t=>t.ok?t.json():t.json().then((t=>{throw new Error(t.message||"Server error occurred")})))).then((e=>{if(!e||!e.success)throw new Error(e.message||"Invalid response format");t.removeClass("loading"),t.closest(".row-contents").addClass("dblock"),t.find(".widget-settings").html(e.data.html),t.removeClass("state-preview").addClass("state-edit"),jQuery(document).trigger("fpbuddy_on_widget_edit",[t])})).catch((e=>{t.removeClass("loading"),console.error("Error:",e),t.find(".widget-settings").html(`<div class="response alert-error">${e.message}</div>`)}))}bindWidgetOptsUpdate(t){const e=this;let s=t.find("form");var i={headers:{"X-WP-Nonce":FRONTPAGE_BUDDY.config.rest_nonce},beforeSerialize:function(){},beforeSubmit:function(){t.find(".response").remove(),t.addClass("loading")},success:function(i){t.removeClass("loading"),i.success?(i.message&&s.append(`<div class="response alert-success">${i.message}</div>`),t.trigger("widget_updated"),e._l.parent.trigger("content_updated")):i.message&&s.append(`<div class="response alert-error">${i.message}</div>`)}};s.ajaxForm(i)}}class FPBuddyLayoutManager{options={};_l={};initial_content="";widgets_manager={};max_cols=2;constructor(t,e,s){this.options=jQuery.extend({},this.options,t),this.initial_content=e,this.widgets_manager=s,this.setup=this.setup.bind(this),this.setup()}setup(){const t=this;if(Object.prototype.hasOwnProperty.call(t.options,"parent")&&(t._l.parent=t.options.parent),!Object.prototype.hasOwnProperty.call(t._l,"parent"))return!1;t.initLayout(this.initial_content),t._l.parent.sortable({items:" > .row-content",handle:".row-actions",placeholder:"lrow sortable-placeholder",update:function(e,s){t._l.parent.trigger("content_updated")}}),t._l.parent.on("click",".row-add-new a",(function(e){e.preventDefault();let s='<div class="lrow row-content lcol-1">';s+='<div class="row-actions">',s+='<div class="fp-mover"><i class="gg-select"></i><span>'+FRONTPAGE_BUDDY.lang.drag_move+"</span></div>",s+='<div class="remove_item remove_row"><a href="#"><i class="gg-close-r"></i></a></div>',s+="</div>",s+='<div class="row-contents">';let i=0;for(;i<t.max_cols;)s+='<div class="lcol">',s+=t.getExpndWidgetOptionsButton(),s+="</div>",i++;s+="</div>",s+="</div>\x3c!-- .row --\x3e",t._l.parent.find(".row-add-new").before(s)})),t._l.parent.on("click"," .remove_row a",(function(e){e.preventDefault();let s=jQuery(this).closest(".lrow"),i=!0,n=!1;s.find(".fp-widget").length>0&&(n=!0),n&&(i=confirm(FRONTPAGE_BUDDY.lang.confirm_delete_section)),i&&(s.remove(),t._l.parent.trigger("content_updated"))})),t._l.parent.on("click"," .remove_widget a",(function(e){e.preventDefault();let s=jQuery(this).closest(".lcol"),i=!0,n=!1;if(s.find(".fp-widget").length&&(n=!0,i=confirm(FRONTPAGE_BUDDY.lang.confirm_delete_widget)),i){let e=t.getExpndWidgetOptionsButton();s.html(e);let i=s.closest(".row-contents");0===i.find(".fp-widget.state-edit").length&&0===i.find(".all-widgets-list").length&&i.removeClass("dblock"),n&&t._l.parent.trigger("content_updated")}})),t._l.parent.on("click"," .splitter a",(function(e){e.preventDefault();let s=jQuery(this).closest(".lrow");if(s.hasClass("lcol-1")){let e='<div class="lcol">';e+=t.getExpndWidgetOptionsButton(),e+="</div>",s.find(".lcol").after(e),s.removeClass("lcol-1").addClass("lcol-2")}})),t._l.parent.on("click"," .expand-widgets-list a",(function(e){e.preventDefault();let s=jQuery(this).closest(".lcol"),i='<div class="choose-widget-to-add">';i+=t.getCollapseWidgetOptionsButton(),i+=t.widgets_manager.getWidgetsList(),i+="</div>",s.html(i),s.closest(".row-contents").addClass("dblock")})),t._l.parent.on("click"," .collapse-widgets-list a",(function(e){e.preventDefault();let s=jQuery(this).closest(".lcol"),i=t.getExpndWidgetOptionsButton();s.html(i);let n=s.closest(".row-contents");0===n.find(".fp-widget.state-edit").length&&0===n.find(".all-widgets-list").length&&n.removeClass("dblock")})),t._l.parent.on("click"," .widget-choose a",(function(e){e.preventDefault();let s=jQuery(this).closest(".widget-to-add").attr("data-type");t.widgets_manager.initNewWidget(s,jQuery(this).closest(".lcol"))})),t._l.parent.on("content_updated",(function(){let e=[];jQuery(t._l.parent).find(".row-content").each((function(){let t=[];jQuery(this).find(".fp-widget").each((function(){t.push(jQuery(this).data("id"))})),t.length>0&&e.push(t)})),fetch(FRONTPAGE_BUDDY.config.rest_url_base+"/layout",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":FRONTPAGE_BUDDY.config.rest_nonce},body:JSON.stringify({object_type:FRONTPAGE_BUDDY.object_type,object_id:FRONTPAGE_BUDDY.object_id,layout:e})})}))}initLayout(t){const e=this;let s="";if(t.length>0&&"object"==typeof t)for(let i of t){s+=`<div class="lrow row-content ${i.length>1?"lcol-2":"lcol-1"}">`,s+='<div class="row-actions">',s+='<div class="fp-mover"><i class="gg-select"></i><span>'+FRONTPAGE_BUDDY.lang.drag_move+"</span></div>",s+='<div class="remove_item remove_row"><a href="#"><i class="gg-close-r"></i></a></div>',s+="</div>\x3c!-- .row-actions --\x3e",s+='<div class="row-contents">';let t=0;for(let n of i)s+='<div class="lcol">',""!==n?(s+='<div class="widget-content">',s+=e.widgets_manager.getWidgetContents(n),s+="</div>"):s+=e.getExpndWidgetOptionsButton(),s+="</div>",t++;if(t<e.max_cols)for(;t<e.max_cols;)s+='<div class="lcol">',s+=e.getExpndWidgetOptionsButton(),s+="</div>",t++;s+="</div>\x3c!-- .row-contents --\x3e",s+="</div>\x3c!-- .row --\x3e"}s+='<div class="row-add-new"><a href="#"><span class="gg-add"></span><span>'+FRONTPAGE_BUDDY.lang.add_section+"</span></a></div>",e._l.parent.html(s)}getExpndWidgetOptionsButton(){return'\n\t\t\t<div class="new-widget">\n\t\t\t\t<div class="expand-widgets-list">\n\t\t\t\t\t<a href="#">\n\t\t\t\t\t\t<i class="gg-add"></i>\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'}getCollapseWidgetOptionsButton(){return`\n\t\t\t<div class="collapse-widgets-list">\n\t\t\t\t<div class="fp-widget-title">${FRONTPAGE_BUDDY.lang.choose_widget}</div>\n\t\t\t\t<div class="remove_item remove_widget"><a href="#"><i class="gg-close-r"></i></a></div>\n\t\t\t</div>\n\t\t`}}jQuery((t=>{new FPBuddyWidgetsManager({el_outer:".fpbuddy_manage_widgets",el_content:"#fpbuddy_fp_layout_outer"})}));