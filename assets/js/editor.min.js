class FPBuddyWidgetsManager{_l={};layout_manager={};options={el_content:""};constructor(t){this.options=jQuery.extend({},this.options,t),this.setup=this.setup.bind(this),this.setup()}setup(){const t=this;if(!t.getElements())return!1;let e=this._l.parent.closest("form");e.length>0&&e.after(this._l.outer),this._l.parent.width()<500&&this._l.parent.addClass("layout-small"),jQuery('input[name="has_custom_frontpage"]').change((function(){t.toggleFPStatus(jQuery(this))})),t._l.parent.on("click",".fp-widget .js-toggle-widget-state",(function(e){e.preventDefault();let i=jQuery(this).closest(".fp-widget");if(i.hasClass("state-preview"))t.showWidgetOpts(i);else{i.addClass("state-preview").removeClass("state-edit");let t=i.closest(".row-contents");0===t.find(".fp-widget.state-edit").length&&0===t.find(".all-widgets-list").length&&t.removeClass("dblock")}})),t.layout_manager=new FPBuddyLayoutManager({parent:t._l.parent},FRONTPAGE_BUDDY.fp_layout,t),jQuery(document).on("fpbuddy_on_widget_edit",(function(e,i){"richcontent"===i.data("type")&&i.find("textarea").trumbowyg({btns:FRONTPAGE_BUDDY.rich_content.editor_btns,minimalLinks:!0}),t.bindWidgetOptsUpdate(i)})),t._l.parent.on("widget_updated",".fp-widget",(function(){const t=jQuery(this);let e=t.find(".field-heading input").val();if(e&&(e=jQuery.trim(e)),e)e=e.substring(0,100);else if(t.hasClass("widget-richcontent")){let i=t.find(".field .trumbowyg-box textarea").first().val();i.length>0&&(e=jQuery("<div>").html(i).text().substring(0,100))}else if(t.hasClass("widget-instagramprofile")){let i=t.find('.field [name="insta_id"]').first().val();i.length>0&&(i=jQuery.trim(i),e="@"+i.replace("@","")+" - instagram")}else if(t.hasClass("widget-twitterprofile")){let i=t.find('.field [name="username"]').first().val();i.length>0&&(i=jQuery.trim(insta_id),e="@"+i.replace("@","")+" - X")}else e=t.attr("data-type");t.find(".fp-widget-title > span:last").text(e)}))}getElements(){return this._l.outer=jQuery(this.options.el_outer),this._l.parent=jQuery(this.options.el_content),this._l.parent.length>0}toggleFPStatus(t){let e="no";t.is(":checked")&&(e="yes"),"yes"==e?(jQuery(".show_if_fp_enabled").removeClass("fpbuddy_hidden"),jQuery(".hide_if_fp_enabled").addClass("fpbuddy_hidden")):(jQuery(".show_if_fp_enabled").addClass("fpbuddy_hidden"),jQuery(".hide_if_fp_enabled").removeClass("fpbuddy_hidden"));let i={action:FRONTPAGE_BUDDY.config.req.change_status.action,_wpnonce:FRONTPAGE_BUDDY.config.req.change_status.nonce,object_type:FRONTPAGE_BUDDY.object_type,object_id:FRONTPAGE_BUDDY.object_id,updated_status:e};jQuery.ajax({type:"POST",url:FRONTPAGE_BUDDY.config.ajaxurl,data:i})}getWidgetsList(){let t='<div class="all-widgets-list">';for(let e of FRONTPAGE_BUDDY.all_widgets)t+=`\n\t\t\t<div class="widget-to-add widget-${e.type}" data-type="${e.type}">\n\t\t\t\t<div class="widget-choose">\n\t\t\t\t\t<a href="#">\n\t\t\t\t\t\t<i class="gg-add"></i>\n\t\t\t\t\t\t<span>${e.name}</span>\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t`;return t+="</div>",t}initNewWidget(t,e){let i=Date.now()+"_"+Math.random(),s="",n="";for(let e of FRONTPAGE_BUDDY.all_widgets)if(e.type===t){s=e.name,n=e.icon;break}let a=`\n\t\t\t<div class='widget-content'>\n\t\t\t\t<div class="fp-widget state-preview widget-${t}" data-id="${i}" data-type="${t}">\n\t\t\t\t\t<div class="fp-widget-header">\n\t\t\t\t\t\t<div class="fp-widget-title js-toggle-widget-state">\n\t\t\t\t\t\t\t${n}\n\t\t\t\t\t\t\t<span>${s}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="remove_item remove_widget">\n\t\t\t\t\t\t\t<a href="#"><i class="gg-close-r"></i></a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="widget-settings"></div>\n\t\t\t\t\t<div class="loading_overlay"><span class="helper"></span><img src="${FRONTPAGE_BUDDY.config.img_spinner}" ></div>\n\t\t\t\t</div>\n\t\t\t</div>\t\n\t\t`;e.html(a),this.showWidgetOpts(e.find(".fp-widget"))}getWidgetContents(t){let e=!1,i="",s="",n="",a="";for(let e of FRONTPAGE_BUDDY.added_widgets)if(e.id===t){i=e.type,s=e.title;break}if(i)for(let t of FRONTPAGE_BUDDY.all_widgets)if(t.type===i){s=s.length>0?s:t.name,a=t.description,n=t.icon,e=!0;break}return e?`\n\t\t\t<div class="fp-widget state-preview widget-${i}" data-id="${t}" data-type="${i}">\n\t\t\t\t<div class="fp-widget-header">\n\t\t\t\t\t<div class="fp-widget-title js-toggle-widget-state">\n\t\t\t\t\t\t${n}\n\t\t\t\t\t\t<span>${s}</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="remove_item remove_widget">\n\t\t\t\t\t\t<a href="#"><i class="gg-close-r"></i></a>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t\n\t\t\t\t<div class="widget-desc"><i class="gg-info"></i>${a}</div>\n\n\t\t\t\t<div class="widget-settings"></div>\n\n\t\t\t\t<div class="loading_overlay"><span class="helper"></span><img src="${FRONTPAGE_BUDDY.config.img_spinner}" ></div>\n\t\t\t</div>\n\t\t`:`\n\t\t\t\t<div>${FRONTPAGE_BUDDY.lang.invalid}</div>\n\t\t\t\t<div class="remove_item remove_widget">\n\t\t\t\t\t<a href="#"></a>\n\t\t\t\t</div>\n\t\t\t`}showWidgetOpts(t){if(t.find(".widget-settings form").length>0)return t.closest(".row-contents").addClass("dblock"),t.removeClass("state-preview").addClass("state-edit"),!1;t.addClass("loading");let e={action:FRONTPAGE_BUDDY.config.req.widget_opts_get.action,_wpnonce:FRONTPAGE_BUDDY.config.req.widget_opts_get.nonce,object_type:FRONTPAGE_BUDDY.object_type,object_id:FRONTPAGE_BUDDY.object_id,widget_type:t.data("type"),widget_id:t.data("id")};jQuery.ajax({type:"GET",url:FRONTPAGE_BUDDY.config.ajaxurl,data:e}).done((function(e){t.removeClass("loading"),e.success&&(t.closest(".row-contents").addClass("dblock"),t.find(".widget-settings").html(e.data.html),t.removeClass("state-preview").addClass("state-edit"),jQuery(document).trigger("fpbuddy_on_widget_edit",[t]))}))}bindWidgetOptsUpdate(t){const e=this;let i=t.find("form");var s={beforeSerialize:function(){},beforeSubmit:function(){t.find(".response").remove(),t.addClass("loading")},success:function(s){t.removeClass("loading"),s.success?(s.data.message&&i.append(`<div class="response alert-success">${s.data.message}</div>`),t.trigger("widget_updated"),e._l.parent.trigger("content_updated")):s.data.message&&i.append(`<div class="response alert-error">${s.data.message}</div>`)}};i.ajaxForm(s)}}class FPBuddyLayoutManager{options={};_l={};initial_content="";widgets_manager={};max_cols=2;constructor(t,e,i){this.options=jQuery.extend({},this.options,t),this.initial_content=e,this.widgets_manager=i,this.setup=this.setup.bind(this),this.setup()}setup(){const t=this;if(Object.prototype.hasOwnProperty.call(t.options,"parent")&&(t._l.parent=t.options.parent),!Object.prototype.hasOwnProperty.call(t._l,"parent"))return!1;t.initLayout(this.initial_content),t._l.parent.sortable({items:" > .row-content",handle:".row-actions",placeholder:"lrow sortable-placeholder",update:function(e,i){t._l.parent.trigger("content_updated")}}),t._l.parent.on("click",".row-add-new a",(function(e){e.preventDefault();let i='<div class="lrow row-content lcol-1">';i+='<div class="row-actions">',i+='<div class="fp-mover"><i class="gg-select"></i><span>'+FRONTPAGE_BUDDY.lang.drag_move+"</span></div>",i+='<div class="remove_item remove_row"><a href="#"><i class="gg-close-r"></i></a></div>',i+="</div>",i+='<div class="row-contents">';let s=0;for(;s<t.max_cols;)i+='<div class="lcol">',i+=t.getExpndWidgetOptionsButton(),i+="</div>",s++;i+="</div>",i+="</div>\x3c!-- .row --\x3e",t._l.parent.find(".row-add-new").before(i)})),t._l.parent.on("click"," .remove_row a",(function(e){e.preventDefault();let i=jQuery(this).closest(".lrow"),s=!0,n=!1;i.find(".fp-widget").length>0&&(n=!0),n&&(s=confirm(FRONTPAGE_BUDDY.lang.confirm_delete_section)),s&&(i.remove(),t._l.parent.trigger("content_updated"))})),t._l.parent.on("click"," .remove_widget a",(function(e){e.preventDefault();let i=jQuery(this).closest(".lcol"),s=!0,n=!1;if(i.find(".fp-widget").length&&(n=!0,s=confirm(FRONTPAGE_BUDDY.lang.confirm_delete_widget)),s){let e=t.getExpndWidgetOptionsButton();i.html(e);let s=i.closest(".row-contents");0===s.find(".fp-widget.state-edit").length&&0===s.find(".all-widgets-list").length&&s.removeClass("dblock"),n&&t._l.parent.trigger("content_updated")}})),t._l.parent.on("click"," .splitter a",(function(e){e.preventDefault();let i=jQuery(this).closest(".lrow");if(i.hasClass("lcol-1")){let e='<div class="lcol">';e+=t.getExpndWidgetOptionsButton(),e+="</div>",i.find(".lcol").after(e),i.removeClass("lcol-1").addClass("lcol-2")}})),t._l.parent.on("click"," .expand-widgets-list a",(function(e){e.preventDefault();let i=jQuery(this).closest(".lcol"),s='<div class="choose-widget-to-add">';s+=t.getCollapseWidgetOptionsButton(),s+=t.widgets_manager.getWidgetsList(),s+="</div>",i.html(s),i.closest(".row-contents").addClass("dblock")})),t._l.parent.on("click"," .collapse-widgets-list a",(function(e){e.preventDefault();let i=jQuery(this).closest(".lcol"),s=t.getExpndWidgetOptionsButton();i.html(s);let n=i.closest(".row-contents");0===n.find(".fp-widget.state-edit").length&&0===n.find(".all-widgets-list").length&&n.removeClass("dblock")})),t._l.parent.on("click"," .widget-choose a",(function(e){e.preventDefault();let i=jQuery(this).closest(".widget-to-add").attr("data-type");t.widgets_manager.initNewWidget(i,jQuery(this).closest(".lcol"))})),t._l.parent.on("content_updated",(function(){let e=[];jQuery(t._l.parent).find(".row-content").each((function(){let t=[];jQuery(this).find(".fp-widget").each((function(){t.push(jQuery(this).data("id"))})),t.length>0&&e.push(t)}));let i={action:FRONTPAGE_BUDDY.config.req.update_layout.action,_wpnonce:FRONTPAGE_BUDDY.config.req.update_layout.nonce,object_type:FRONTPAGE_BUDDY.object_type,object_id:FRONTPAGE_BUDDY.object_id,layout:e};jQuery.ajax({type:"POST",url:FRONTPAGE_BUDDY.config.ajaxurl,data:i})}))}initLayout(t){const e=this;let i="";if(t.length>0&&"object"==typeof t)for(let s of t){i+=`<div class="lrow row-content ${s.length>1?"lcol-2":"lcol-1"}">`,i+='<div class="row-actions">',i+='<div class="fp-mover"><i class="gg-select"></i><span>'+FRONTPAGE_BUDDY.lang.drag_move+"</span></div>",i+='<div class="remove_item remove_row"><a href="#"><i class="gg-close-r"></i></a></div>',i+="</div>\x3c!-- .row-actions --\x3e",i+='<div class="row-contents">';let t=0;for(let n of s)i+='<div class="lcol">',""!==n?(i+='<div class="widget-content">',i+=e.widgets_manager.getWidgetContents(n),i+="</div>"):i+=e.getExpndWidgetOptionsButton(),i+="</div>",t++;if(t<e.max_cols)for(;t<e.max_cols;)i+='<div class="lcol">',i+=e.getExpndWidgetOptionsButton(),i+="</div>",t++;i+="</div>\x3c!-- .row-contents --\x3e",i+="</div>\x3c!-- .row --\x3e"}i+='<div class="row-add-new"><a href="#"><span class="gg-add"></span><span>'+FRONTPAGE_BUDDY.lang.add_section+"</span></a></div>",e._l.parent.html(i)}getExpndWidgetOptionsButton(){return'\n\t\t\t<div class="new-widget">\n\t\t\t\t<div class="expand-widgets-list">\n\t\t\t\t\t<a href="#">\n\t\t\t\t\t\t<i class="gg-add"></i>\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'}getCollapseWidgetOptionsButton(){return`\n\t\t\t<div class="collapse-widgets-list">\n\t\t\t\t<div class="fp-widget-title">${FRONTPAGE_BUDDY.lang.choose_widget}</div>\n\t\t\t\t<div class="remove_item remove_widget"><a href="#"><i class="gg-close-r"></i></a></div>\n\t\t\t</div>\n\t\t`}}jQuery((t=>{new FPBuddyWidgetsManager({el_outer:".fpbuddy_manage_widgets",el_content:"#fpbuddy_fp_layout_outer"})}));